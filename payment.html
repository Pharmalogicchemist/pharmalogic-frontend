<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pharmalogic - Complete Payment</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    body {
      background: #f8f9fa;
      font-family: Arial, sans-serif;
    }
  </style>
</head>

<body class="p-6">

  <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow">
    <h1 class="text-3xl font-bold text-green-800 mb-4 text-center">
      Complete Your Payment
    </h1>

    <p id="status-message" class="text-center text-lg text-gray-700 mb-4">
      Loading order details...
    </p>

    <!-- Order Summary Section -->
    <div id="order-summary" class="hidden">
      <h2 class="text-2xl font-semibold mt-4 mb-2 text-gray-800">Order Summary</h2>

      <div class="p-4 border rounded bg-gray-50">
        <p><strong>Order ID:</strong> <span id="order-id"></span></p>
        <p><strong>Name:</strong> <span id="patient-name"></span></p>
        <p><strong>Email:</strong> <span id="billing-email"></span></p>
        <p><strong>Phone:</strong> <span id="billing-phone"></span></p>
        <p><strong>Address:</strong> <span id="billing-address"></span></p>

        <hr class="my-3" />

        <p><strong>Mounjaro Strength:</strong> <span id="strength"></span></p>
        <p><strong>Total Price:</strong> £<span id="price"></span></p>

        <p class="mt-3">
          <strong>Order Status:</strong> 
          <span id="order-status" class="font-semibold"></span>
        </p>
      </div>

      <div class="text-center mt-6">
        <button id="pay-now-btn"
          class="bg-green-700 text-white px-6 py-3 text-lg rounded-lg hover:bg-green-800">
          Proceed to Secure Payment
        </button>
      </div>
    </div>
  </div>

<script>
/****************************************************
   1) Read order_id from URL
*****************************************************/
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get("order_id");

if (!orderId) {
  document.getElementById("status-message").innerText =
    "❌ Invalid URL. Order ID missing.";
}

/****************************************************
   2) Fetch order details from backend
*****************************************************/
async function loadOrder() {
  try {
    const res = await fetch(`/api/get-order?order_id=${orderId}`);
    const data = await res.json();

    if (!data.success) {
      document.getElementById("status-message").innerText =
        "❌ Unable to load order details.";
      return;
    }

    const order = data.order;

    // Fill UI with order details
    document.getElementById("order-id").innerText = orderId;
    document.getElementById("patient-name").innerText = order.patient_name;
    document.getElementById("billing-email").innerText = order.billing_email;
    document.getElementById("billing-phone").innerText = order.billing_phone;
    document.getElementById("billing-address").innerText =
      `${order.billing_address_1}, ${order.billing_city}, ${order.billing_postcode}`;
    document.getElementById("strength").innerText = order.mounjaro_strength;

    // FIXED PRICE TABLE
    const priceMap = {
      "2.5mg": 125,
      "5mg": 145,
      "7.5mg": 165,
      "10mg": 185,
      "12.5mg": 195,
      "15mg": 205
    };

    const price = priceMap[order.mounjaro_strength] || 125;
    document.getElementById("price").innerText = price;

    document.getElementById("order-status").innerText = order.order_status;

    document.getElementById("status-message").classList.add("hidden");
    document.getElementById("order-summary").classList.remove("hidden");

  } catch (error) {
    console.error("Fetch error:", error);
    document.getElementById("status-message").innerText =
      "❌ Server error while loading order.";
  }
}

loadOrder();

/****************************************************
   3) Create Stripe checkout session using backend
*****************************************************/
document.getElementById("pay-now-btn").addEventListener("click", async () => {
  try {
    const res = await fetch("/api/create-checkout-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order_id: orderId })
    });

    const data = await res.json();

    if (!data.success) {
      alert("Payment error: " + data.message);
      return;
    }

    const stripe = Stripe(data.publicKey);

    // Redirect to Stripe secure hosted checkout
    await stripe.redirectToCheckout({ sessionId: data.sessionId });

  } catch (err) {
    console.error("Stripe error:", err);
    alert("Payment service error.");
  }
});
</script>

</body>
</html>
